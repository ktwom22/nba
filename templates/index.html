<!DOCTYPE html>
<html>
<head>
  <title>NBA DraftKings Optimizer</title>
  <style>
    body { font-family: Arial, sans-serif; background: #fafafa; margin: 2em; }
    table { border-collapse: collapse; width: 100%; background: white; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #333; color: white; cursor: pointer; }
    h2 { color: #222; }
    input[type=number] { width: 80px; padding: 4px; }
    .controls { margin-bottom: 1em; }
    .search-box { margin-left: 1em; padding: 4px; width: 200px; }
  </style>
  <script>
    let playerState = {};

    function toggleInclude(idx) {
      playerState[idx] = !playerState[idx];
    }

    function filterTable() {
      const search = document.getElementById("search").value.toLowerCase();
      const rows = document.querySelectorAll("#playerTable tbody tr");
      rows.forEach(row => {
        const player = row.querySelector("td:nth-child(3)").innerText.toLowerCase();
        row.style.display = player.includes(search) ? "" : "none";
      });
    }

    function sortTable(n) {
      const table = document.getElementById("playerTable");
      let switching = true, dir = "asc", switchcount = 0;
      while (switching) {
        switching = false;
        const rows = table.rows;
        for (let i = 1; i < (rows.length - 1); i++) {
          let shouldSwitch = false;
          let x = rows[i].getElementsByTagName("TD")[n];
          let y = rows[i + 1].getElementsByTagName("TD")[n];
          let xVal = isNaN(parseFloat(x.innerText.replace(/[$,]/g, ""))) ? x.innerText.toLowerCase() : parseFloat(x.innerText.replace(/[$,]/g, ""));
          let yVal = isNaN(parseFloat(y.innerText.replace(/[$,]/g, ""))) ? y.innerText.toLowerCase() : parseFloat(y.innerText.replace(/[$,]/g, ""));
          if (dir === "asc" ? xVal > yVal : xVal < yVal) {
            shouldSwitch = true;
            break;
          }
        }
        if (shouldSwitch) {
          rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
          switching = true;
          switchcount++;
        } else {
          if (switchcount === 0 && dir === "asc") {
            dir = "desc";
            switching = true;
          }
        }
      }
    }

    function submitForm() {
      const form = document.getElementById("playerForm");
      const hiddenInput = document.getElementById("playerState");
      hiddenInput.value = JSON.stringify(playerState);
      form.submit();
    }
  </script>
</head>
<body>
  <h2>üèÄ NBA DraftKings Optimizer</h2>

  <form id="playerForm" action="/optimize" method="post">
    <div class="controls">
      <label for="lineup_count"># of Lineups:</label>
      <input type="number" name="lineup_count" id="lineup_count" value="10" min="1" max="50">
      <input type="text" id="search" class="search-box" onkeyup="filterTable()" placeholder="Search players...">
      <input type="hidden" id="playerState" name="player_state">
      <button type="button" onclick="submitForm()">Optimize</button>
    </div>

    <table id="playerTable">
      <thead>
        <tr>
          <th>Include</th>
          <th onclick="sortTable(1)">POS</th>
          <th onclick="sortTable(2)">Player</th>
          <th onclick="sortTable(3)">Team</th>
          <th onclick="sortTable(4)">Salary</th>
          <th onclick="sortTable(5)">Projected</th>
          <th onclick="sortTable(6)">Usage</th>
        </tr>
      </thead>
      <tbody>
        {% for p in players %}
        <tr>
          <td><input type="checkbox" checked onchange="toggleInclude('{{ p['PLAYER'] }}')"></td>
          <td>{{ p['POS'] }}</td>
          <td>{{ p['PLAYER'] }}</td>
          <td>{{ p['TEAM'] }}</td>
          <td>${{ "{:,.0f}".format(p['SALARY']) }}</td>
          <td>{{ p['PROJ'] }}</td>
          <td>{{ p['USAGE'] }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </form>
</body>
</html>
